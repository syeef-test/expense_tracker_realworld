<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>
  <style>
    body {
      padding-top: 50px;
    }
  </style>

</head>

<body>
  <div class="container" align="center">
    <div align="right" id="message">
      
    </div>
    <div class="row">
      <div>
        <h2>Expense Page</h2>
      </div>
      <div>
        <form onsubmit="addExpense(event)" class="form-horizontal">
          <div class="form-group">
            <div class="mb-3">
              <label for="expenseAmount" class="form-label">Enter Expense Amount:</label>
              <input type="number" class="form-control" name="expenseAmount" id="expenseAmount" required />
            </div>
          </div>
          <div class="form-group">
            <div class="mb-3">
              <label for="description" class="form-label">Choose Description:</label>
              <input type="text" class="form-control" name="description" id="description" required />
            </div>
          </div>
          <div class="form-group">
            <div class="mb-3">
              <label for="category" class="form-label">Choose Category:</label>
              <select class="form-select" name="category" id="category" required>
                <option value="fuel" selected>Fuel</option>
                <option value="fruit">Fruit</option>
                <option value="travel">Travel</option>
                <option value="electricty">Electricty</option>
                <option value="food">Food</option>
                <option value="movie">Movie</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <div class="mb-3">
              <input class="btn btn-success" type="submit" name="button" id="button" value="Add Expense" />
            </div>
          </div>

        </form>
        <div class="form-group" id="payment" name="payment">
          <div class="mb-3">
            <input class="btn btn-warning" type="button" name="rzp-button1" id="rzp-button1" value="Buy Premium" />
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <ul id="listOfExpenses">

            </ul>
          </div>
        </div>
        <div>
          <ul id="expense" class="list-group"></ul>
        </div>

      </div>
    </div>
  </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>


  function showPremiumuserMessage(){
      document.getElementById('rzp-button1').style.visibility = 'hidden';
        document.getElementById('message').innerHTML = 'You are a premiuem user';
  }

  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
  }

  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const token = localStorage.getItem('token');

      const decodeToken = parseJwt(token);
      console.log(decodeToken);
      const ispremiuemuser = decodeToken.ispremiuemuser;
      if(ispremiuemuser){
        showPremiumuserMessage();
      }

      const responseExpense = await axios.get("http://127.0.0.1:3000/expense/get_expense", {
          headers: {
            'authorization': token
          }
        });
        
      

      if (responseExpense !== null) {
        const data = responseExpense.data;
        if (responseExpense.data.data.length !== 0) {
          data.data.forEach((element) => {
            //console.log(element);
            showExpenseonScreen(element);
          });
        }
      }

      

    } catch (error) {
      console.log(error);
    }
  });


  async function addExpense(event) {
    try {
      event.preventDefault();
      const expsenseAmount = event.target.expenseAmount.value;
      const description = event.target.description.value;
      const category = event.target.category.value;

      const obj = {
        expsenseAmount: expsenseAmount,
        description: description,
        category: category
      }
      //console.log(obj);
      const token = localStorage.getItem('token');
      const addExpense = await axios.post('http://127.0.0.1:3000/expense/addexpense', obj, {
        headers: {
          'authorization': token
        }
      });

      if (addExpense.status === 201) {
        alert(addExpense.data.message);
        showExpenseonScreen(addExpense.data.data);
      }
    } catch (error) {
      if (error) {
        //alert(error.response.data.error);
        console.log(error);
      }



    }
  }




  function showExpenseonScreen(obj) {
    try {
      const parentElem = document.getElementById("expense");
      //const childElem = document.createElement('li');
      const childElem = `<li class="list-group-item" id=${obj.id}>${obj.expenseamount}-${obj.category}-${obj.description}&nbsp<button class="btn btn-danger" onclick=deleteExpense('${obj.id}')>Delete</button></li>`;

      parentElem.innerHTML = parentElem.innerHTML + childElem;
    } catch (error) {
      console.log(error);
    }
  }

  function deleteExpenseFromScreen(expenseId) {
    try {
      const parentElem = document.getElementById("expense");
      const childElem = document.getElementById(expenseId);
      parentElem.removeChild(childElem); //element removed from parent element
    } catch (error) {
      console.log(error);
    }
  }

  async function deleteExpense(expenseId) {
    try {
      //console.log(expenseId);
      const token = localStorage.getItem('token');
      const response = await axios.delete(
        `http://127.0.0.1:3000/expense/deleteExpense/${expenseId}`,
        {
          headers: {
            'authorization': token
          }
        }
      );
      if (response.status === 200) {
        //console.log(response.status);
        deleteExpenseFromScreen(expenseId);
      } else {
        console.log("Not Deleted");
      }
    } catch (error) {
      console.log(error);
    }
  }




  


  document.getElementById("rzp-button1").onclick = async function (e) {
    const token = localStorage.getItem('token');
    const response = await axios.get('http://127.0.0.1:3000/purchase/premiummembership', {
      headers: {
        'authorization': token
      }
    });
    //console.log(response);

    var options =
    {
      "key": response.data.key_id, //enter the key_id generated from the dashboard
      "order_id": response.data.order.id,  //for one time payment
      //this handler function will handle the success payment
      "handler": async function (response) {

        const res = await axios.post('http://127.0.0.1:3000/purchase/updatetransactionstatus',
          { order_id: response.razorpay_order_id, payment_id: response.razorpay_payment_id }, {
          headers: {
            'authorization': token
          }
        });
        
        alert('You are a Premium User Now');
        showPremiumuserMessage();
        localStorage.setItem('token',res.data.token);


      }
    };

    const rzp1 = new Razorpay(options);
    rzp1.open();
    e.preventDefault();


    rzp1.on('payment.failed', async function (response) {
      //console.log(response);
      //alert(response.error.code);
      //alert(response.error.metadata.order_id);
      //alert(response.error.metadata.payment_id);

      alert('Something Went Wrong Please Try Again Later');
      await axios.post('http://127.0.0.1:3000/purchase/updatetransactionstatus',
        { order_id: response.error.metadata.order_id, payment_id: response.error.metadata.payment_id, error_code: response.error.code }, {
        headers: {
          'authorization': token
        }
      });
    });

  }
</script>

</html>